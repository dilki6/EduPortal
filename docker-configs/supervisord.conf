[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
loglevel=info

# ============================================
# Ollama AI Service (Priority 1 - Start First)
# ============================================
[program:ollama]
command=/usr/local/bin/ollama serve
autostart=false
autorestart=true
startretries=5
priority=1
stdout_logfile=/var/log/supervisor/ollama-stdout.log
stderr_logfile=/var/log/supervisor/ollama-stderr.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile_backups=3
user=eduportal
environment=HOME="/home/eduportal",OLLAMA_HOST="0.0.0.0:11434"
# Started manually in entrypoint.sh for better error handling

# ============================================
# Backend API (Priority 2 - Start Second)
# ============================================
[program:backend]
command=/app/EduPortal.Api
directory=/app
autostart=true
autorestart=true
startretries=10
priority=2
stdout_logfile=/var/log/supervisor/backend-stdout.log
stderr_logfile=/var/log/supervisor/backend-stderr.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile_backups=3
user=eduportal
environment=ASPNETCORE_ENVIRONMENT="Production",ASPNETCORE_URLS="http://+:5000",DOTNET_RUNNING_IN_CONTAINER="true"
stopwaitsecs=30

# ============================================
# Nginx Web Server (Priority 3 - Start Last)
# ============================================
[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
startretries=10
priority=3
stdout_logfile=/var/log/supervisor/nginx-stdout.log
stderr_logfile=/var/log/supervisor/nginx-stderr.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile_backups=3
user=root
stopwaitsecs=10
